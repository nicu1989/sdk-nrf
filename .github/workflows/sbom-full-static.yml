name: 1A.SBOM FULL- Static

on:
  pull_request:
  workflow_dispatch:

jobs:
  scan:
    name: Scan chunk ${{ matrix.chunk_index }}
    runs-on: ubuntu-24.04
    env:
      CHUNK_COUNT: "100"
    strategy:
      fail-fast: false
      matrix:
        chunk_index:
          - 0
          - 1
          - 2
          - 3
          - 4
          - 5
          - 6
          - 7
          - 8
          - 9
          - 10
          - 11
          - 12
          - 13
          - 14
          - 15
          - 16
          - 17
          - 18
          - 19
          - 20
          - 21
          - 22
          - 23
          - 24
          - 25
          - 26
          - 27
          - 28
          - 29
          - 30
          - 31
          - 32
          - 33
          - 34
          - 35
          - 36
          - 37
          - 38
          - 39
          - 40
          - 41
          - 42
          - 43
          - 44
          - 45
          - 46
          - 47
          - 48
          - 49
          - 50
          - 51
          - 52
          - 53
          - 54
          - 55
          - 56
          - 57
          - 58
          - 59
          - 60
          - 61
          - 62
          - 63
          - 64
          - 65
          - 66
          - 67
          - 68
          - 69
          - 70
          - 71
          - 72
          - 73
          - 74
          - 75
          - 76
          - 77
          - 78
          - 79
          - 80
          - 81
          - 82
          - 83
          - 84
          - 85
          - 86
          - 87
          - 88
          - 89
          - 90
          - 91
          - 92
          - 93
          - 94
          - 95
          - 96
          - 97
          - 98
          - 99
    steps:
      - name: Checkout repository
        uses: nrfconnect/action-checkout-west-update@main
        with:
          path: nrf
          git-fetch-depth: 0
          git-ref: v3.1.0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-dev bzip2 xz-utils zlib1g libxml2-dev libxslt1-dev libpopt0

      - name: Set up Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38
        with:
          python-version: "3.12"

      - name: Install Python requirements
        working-directory: nrf
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements-fixed.txt
          pip install -r scripts/requirements-west-ncs-sbom.txt

      - name: Prepare input list
        id: prep
        working-directory: nrf
        run: |
          mkdir -p sbom/chunks
          chunk_index="${{ matrix.chunk_index }}"
          chunk_id=$(printf "%03d" "$chunk_index")
          artifact="chunk_${chunk_id}"
          listfile="sbom/chunks/${artifact}.lst"
          export CHUNK_INDEX="$chunk_index"
          export ARTIFACT="$artifact"
          LISTFILE="$listfile" python3 <<'PY'
import math
import os
from pathlib import Path

chunk_count = int(os.environ.get("CHUNK_COUNT", "100"))
chunk_index = int(os.environ["CHUNK_INDEX"])
artifact = os.environ["ARTIFACT"]
chunk_dir = Path("sbom/chunks").resolve()
chunk_dir.mkdir(parents=True, exist_ok=True)
listfile = chunk_dir / f"{artifact}.lst"

root = Path(".").resolve()
ignored_roots = {".git", "sbom", ".venv-ncs-sbom"}

files = []
for path in sorted(root.rglob("*")):
    if not path.is_file():
        continue
    rel = path.relative_to(root)
    if rel.parts and rel.parts[0] in ignored_roots:
        continue
    files.append(path)

total = len(files)
if total == 0 or chunk_count <= 0:
    chunk_entries = []
else:
    chunk_size = math.ceil(total / chunk_count)
    start = chunk_index * chunk_size
    if start >= total:
        chunk_entries = []
    else:
        end = min(start + chunk_size, total)
        chunk_entries = files[start:end]

lines = []
for path in chunk_entries:
    rel_to_chunk = os.path.relpath(path, start=chunk_dir)
    lines.append(rel_to_chunk)

if lines:
    listfile.write_text("\n".join(lines) + "\n")
else:
    listfile.write_text("")

with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
    fh.write(f"total={total}\n")
    if total > 0 and chunk_count > 0:
        chunk_size = math.ceil(total / chunk_count)
        start = chunk_index * chunk_size
        end = min(start + chunk_size, total)
    else:
        start = end = 0
    fh.write(f"chunk_start={start}\n")
    fh.write(f"chunk_end={end}\n")
PY
          if [ ! -s "$listfile" ]; then
            echo "empty=true" >> "$GITHUB_OUTPUT"
            : > "$listfile"
          else
            echo "empty=false" >> "$GITHUB_OUTPUT"
          fi
          echo "LISTFILE: $listfile"
          cat "$listfile"
          echo "ARTIFACT: $artifact"
          echo "listfile=$listfile" >> "$GITHUB_OUTPUT"
          echo "artifact=$artifact" >> "$GITHUB_OUTPUT"

      - name: Run ncs-sbom for chunk ${{ matrix.chunk_index }}
        if: steps.prep.outputs.empty == 'false'
        working-directory: nrf
        run: |
          mkdir -p sbom/chunks
          west ncs-sbom \
            --input-list-file "${{ steps.prep.outputs.listfile }}" \
            --license-detectors scancode-toolkit \
            --optional-license-detectors '' \
            --output-cache-database "sbom/chunks/${{ steps.prep.outputs.artifact }}.json" \
            --output-html "sbom/chunks/${{ steps.prep.outputs.artifact }}.html" \
            -n $(nproc)

      - name: Create empty outputs
        if: steps.prep.outputs.empty == 'true'
        working-directory: nrf
        run: |
          mkdir -p sbom/chunks
          printf '{"files":{}}' > "sbom/chunks/${{ steps.prep.outputs.artifact }}.json"
          cat <<'HTML' > "sbom/chunks/${{ steps.prep.outputs.artifact }}.html"
          <!DOCTYPE html>
          <html lang="en"><body><p>No files detected for this entry.</p></body></html>
          HTML

      - name: Upload chunk artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.prep.outputs.artifact }}
          path: |
            nrf/${{ steps.prep.outputs.listfile }}
            nrf/sbom/chunks/${{ steps.prep.outputs.artifact }}.json
            nrf/sbom/chunks/${{ steps.prep.outputs.artifact }}.html

  assemble:
    name: Assemble combined SBOM
    needs: scan
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: nrfconnect/action-checkout-west-update@main
        with:
          path: nrf
          git-fetch-depth: 0
          git-ref: v3.1.0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-dev bzip2 xz-utils zlib1g libxml2-dev libxslt1-dev libpopt0

      - name: Set up Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38
        with:
          python-version: "3.12"

      - name: Install Python requirements
        working-directory: nrf
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements-fixed.txt
          pip install -r scripts/requirements-west-ncs-sbom.txt

      - name: Download chunk artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: sbom-*
          path: nrf/sbom/chunks
          merge-multiple: false

      - name: Merge cache databases
        working-directory: nrf
        run: |
          python <<'PY'
          import json
          from pathlib import Path

          cache_root = Path("sbom/chunks")
          output = {"files": {}}

          for cache_file in sorted(cache_root.rglob("*.json")):
            data = json.loads(cache_file.read_text())
            for rel_path, record in data.get("files", {}).items():
              existing = output["files"].get(rel_path)
              if existing and existing["sha1"] != record["sha1"]:
                raise SystemExit(
                  f"SHA1 mismatch for {rel_path}: {existing['sha1']} vs {record['sha1']}"
                )
              output["files"][rel_path] = record

          merged_path = Path("sbom/merged-cache.json")
          merged_path.parent.mkdir(parents=True, exist_ok=True)
          merged_path.write_text(json.dumps(output, indent=2))
          PY

      - name: Create aggregated input list
        working-directory: nrf
        run: |
          python <<'PY'
          import os
          from pathlib import Path

          chunks_root = Path("sbom/chunks")
          aggregated = Path("sbom/all-files.lst")
          aggregated.parent.mkdir(parents=True, exist_ok=True)

          files = set()
          for list_path in sorted(chunks_root.rglob("*.lst")):
            base = list_path.parent.resolve()
            try:
              lines = list_path.read_text().splitlines()
            except FileNotFoundError:
              continue
            for line in lines:
              entry = line.strip()
              if not entry or entry.startswith("#"):
                continue
              candidate = (base / entry).resolve()
              if candidate.is_file():
                files.add(candidate)

          sbom_root = aggregated.parent.resolve()
          with aggregated.open("w") as out:
            for path in sorted(files):
              rel_path = os.path.relpath(path, start=sbom_root)
              out.write(f"{rel_path}\n")
          PY

      - name: Generate combined HTML report
        working-directory: nrf
        run: |
          west ncs-sbom \
            --input-list-file sbom/all-files.lst \
            --license-detectors cache-database \
            --optional-license-detectors '' \
            --input-cache-database sbom/merged-cache.json \
            --output-html sbom/nrf-full-static-github-sbomv310.html

      - name: Upload combined SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-combined
          path: |
            nrf/sbom/nrf-full-static-github-sbomv310.html
            nrf/sbom/merged-cache.json
            nrf/sbom/all-files.lst
